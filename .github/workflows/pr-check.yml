name: PR Quality Check

on:
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run lint check
      run: ./gradlew lint --stacktrace
      
    - name: Upload lint results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-results
        path: app/build/reports/lint-results*.html
        
    - name: Run unit tests
      run: ./gradlew test --stacktrace
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-pr
        path: |
          app/build/reports/tests/
          app/build/test-results/
          
    - name: Build debug APK (compilation check)
      run: ./gradlew assembleDebug --stacktrace
      
    - name: Comment PR with results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## ğŸ” PRè´¨é‡æ£€æŸ¥ç»“æœ\n\n';
          
          // æ£€æŸ¥æ„å»ºçŠ¶æ€
          const buildStatus = '${{ job.status }}' === 'success' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
          comment += `### ğŸ“± æ„å»ºçŠ¶æ€: ${buildStatus}\n\n`;
          
          if ('${{ job.status }}' === 'success') {
            comment += '### âœ… æ£€æŸ¥é¡¹ç›®\n';
            comment += '- âœ… ä»£ç ç¼–è¯‘é€šè¿‡\n';
            comment += '- âœ… å•å…ƒæµ‹è¯•é€šè¿‡\n';
            comment += '- âœ… Lintæ£€æŸ¥é€šè¿‡\n';
            comment += '- âœ… APKæ„å»ºæˆåŠŸ\n\n';
            comment += '### ğŸ“¥ æµ‹è¯•APK\n';
            comment += 'å¯ä»¥åœ¨Actionsé¡µé¢çš„Artifactsä¸­ä¸‹è½½æµ‹è¯•APKè¿›è¡ŒéªŒè¯ã€‚\n\n';
          } else {
            comment += '### âŒ æ£€æŸ¥å¤±è´¥\n';
            comment += 'è¯·æ£€æŸ¥Actionsæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä¿®å¤åé‡æ–°æäº¤ã€‚\n\n';
          }
          
          comment += '### ğŸ“‹ ä¸‹ä¸€æ­¥\n';
          comment += '- ç¡®ä¿æ‰€æœ‰æ£€æŸ¥é€šè¿‡\n';
          comment += '- æµ‹è¯•APKåŠŸèƒ½æ­£å¸¸\n';
          comment += '- å‡†å¤‡åˆå¹¶åˆ°ä¸»åˆ†æ”¯\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      continue-on-error: true
      with:
        sarif-file: 'security-scan-results.sarif'
        
    - name: Check for sensitive files
      run: |
        echo "æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶..."
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«å¯†é’¥æ–‡ä»¶
        if find . -name "*.jks" -o -name "*.keystore" -o -name "*.p12" | grep -q .; then
          echo "âš ï¸ å‘ç°å¯†é’¥æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«å¯†ç æˆ–APIå¯†é’¥
        if grep -r -i "password\|api_key\|secret" --include="*.kt" --include="*.java" --include="*.xml" . | grep -v "// TODO\|// FIXME"; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ä»£ç "
          exit 1
        fi
        
        echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"